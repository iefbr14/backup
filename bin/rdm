#!/usr/bin/perl -w

=head1 NAME

=head1 USAGE

=head1 REQUIRED ARGUMENTS

=head1 OPTION

=head1 DESCRIPTION

=head1 DIAGNOSTICS

=head1 EXIT STATUS

=head1 CONFIGURATION

=head1 DEPENDENCIES

=head1 INCOMPATIBILITIES

=head1 BUGS AND LIMITATIONS

=head1 AUTHOR

=head1 LICENSE COPYRIGHT

=cut

#
# $Header: $
#

use strict;
use warnings;
use Getopt::Std;

sub usage {
	die <<"EOF";
Usage: $0 [options...] [machine]...
   --
Options:
   -A     -- do all machines
   -x     -- turn Debugging on.
EOF
}

my(%Opt);
getopts('x', \%Opt) || usage;

my($Debug) = $Opt{x} || 0;


usage() unless @ARGV;

for my $machine (@ARGV) {
	print "==============[ $machine ]==============\n";

	if (! -f "Include/$machine") {
		die "No Include list."
	}

	my(@args) = qw(
		--exclude-sockets
		--exclude-other-filesystems
		--exclude-filelist-stdin
		--print-statistics
	);

	if (! -d "$machine/rdiff-backup-data") {
		push(@args, '--force');
	}

	if ( -f "Include/$machine.force") {
		push(@args, '--force');
	}

	umask(000);

	open(
	while (<>) {
sed -e '/^#/d' -e '/^$/d' -e 's/ *#.*//' Include/$machine | \
	my($rv) = system('rdiff-backup', @args, "$machine::/", $machine);


	if ( -f "Include/$machine.force" ) {
		unlink("Include/$machine.force");
	}
}

sub load_remote {
	my($host) = @_;

	my($fs, $mp, $type);

	open(my $fd, "ssh $host 'cat /proc/mounts'|") or die;
	while (<$fd>) {
		($fs, $mp, $type) = split(' ', $_, 4);

		next if ($mp eq '/');
		if ($type eq 'rootfs') {

	case "$type" in
	rootfs|ext2|ext3|ext4)
		if [ "$mp" = / ] ; then
			continue;
		fi
		echo "+ $mp" >>Dirs.tmp
	;;

	*)	echo "- $mp  ## $type $fs" >>Dirs.tmp
	esac
done

if [ ! -d "$HOST" ] ; then
	mkdir "$HOST"
fi

if [ ! -f "Include/$HOST" ] ; then
	mv Dirs.tmp Include/"$HOST"
fi

touch Include/$HOST.force
echo "Run:      rdiff-machine $HOST"
